name: Release Tags Automation

on:
  push:
    branches:
      - master

jobs:

  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Restore Node.js and semver cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.npm
          ~/.cache
        key: node-semver-${{ runner.os }}-${{ hashFiles('**/*.json') }}

    - name: Install Node.js and semver
      if: steps.restore-cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y nodejs
        sudo apt-get install -y npm
        npm install semver
        echo "Cache not found, installed Node.js and semver"

    - name: Get latest tag
      id: get_tag
      run: |
        latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
        echo "Latest Tag: $latest_tag"
        echo "::set-output name=TAG::$latest_tag"

    - name: Increment version
      id: version
      run: |
        current_version=${{ steps.get_tag.outputs.TAG }}
        new_version=$(node -p "const semver = require('semver'); console.log(semver.inc('$current_version', 'patch'));")
        echo "Incremented Version: $new_version"
        echo "::set-output name=NEW_VERSION::$new_version"

    - name: Automatic Releases
      uses: marvinpinto/action-automatic-releases@v1.2.1
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        automatic_release_tag: v${{ steps.version.outputs.NEW_VERSION }}
        draft: false
        prerelease: true
        title: Release v${{ steps.version.outputs.NEW_VERSION }}

    - name: Save Node.js and semver cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.npm
          ~/.cache
        key: node-semver-${{ runner.os }}-${{ hashFiles('**/*.json') }}
